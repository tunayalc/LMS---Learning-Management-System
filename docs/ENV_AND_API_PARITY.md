## ENV + API parity (no hardcoded host/port)

### Rule

All host/port/baseUrl values come from env files generated by scripts\detect_env.ps1. No defaults are baked into code.

### Flow

1. Detect: pnpm env:detect
2. Env: .env.local or .env.docker is generated from detection
3. Start: pnpm dev:api and pnpm dev:web
4. Verify: pnpm smoke:local (or pnpm smoke:docker)

detect_env.ps1 reuses existing LMS_API_PORT/LMS_WEB_PORT/LMS_OMR_PORT when present so ports stay stable across runs. If a port is already in use, it will reuse it and print a warning.

### Base URL matrix (from env)

- Web (local): LMS_API_BASE_URL_LOCAL (from .env.local)
- Mobile Android emulator (local): LMS_API_BASE_URL_LOCAL_ANDROID (from .env.local)
- Mobile iOS simulator (local): LMS_API_BASE_URL_LOCAL_IOS (from .env.local)
- Docker (all clients): LMS_API_BASE_URL_DOCKER (from .env.docker)
- OMR (local): LMS_OMR_BASE_URL_LOCAL (from .env.local)
- OMR (local Android emulator): LMS_OMR_BASE_URL_LOCAL_ANDROID (from .env.local)
- OMR (local iOS simulator): LMS_OMR_BASE_URL_LOCAL_IOS (from .env.local)
- OMR (docker): LMS_OMR_BASE_URL_DOCKER (from .env.docker)

### Local host resolution

detect_env.ps1 resolves a local host address at runtime (prefers an IPv4 on the active gateway interface; falls back to DNS and then 127.0.0.1). Override with -LocalHost if needed.

### Android emulator note

Android emulator cannot reach the host via localhost. Use 10.0.2.2. The detect script writes this into LMS_API_BASE_URL_LOCAL_ANDROID and can be overridden with -AndroidHost.

### Android physical device note

On a real Android device, LMS_API_BASE_URL_LOCAL (LAN IP) is required. The mobile app detects emulator vs device and picks the right base URL.

If detection is wrong, set LMS_ANDROID_RUNTIME=emulator or LMS_ANDROID_RUNTIME=device in .env.local and run pnpm mobile:env:refresh.

### Mobile (Expo)

Expo reads LMS\_\* values from app.config.ts. Start the mobile app via scripts/run_mobile_local.ps1 so LMS_ENV_FILE is set.
If google-services.json exists but you are not using Firebase yet, keep LMS_ANDROID_GOOGLE_SERVICES=false to avoid config errors.

### CORS

LMS_CORS_ORIGIN controls which web origins can call the API. It accepts a comma-separated list. The detect script writes both LMS_WEB_BASE_URL and a localhost variant so you can open the web app from either host without CORS errors.

### Database

API uses PostgreSQL via LMS_DB_URL. For the existing AppFlowy Postgres container, run:

- scripts\setup_appflowy_pg.ps1 (creates a local proxy and sets LMS_DB_URL)

LMS_DB_SSL=false for local dev.

LMS_DB_MODE controls the fallback:
- auto (default for local): use Postgres if reachable, otherwise fall back to in-memory DB
- postgres: force Postgres (no fallback)
- memory: always use in-memory DB

### Docker compose (skeleton)

docker-compose.yml uses .env.docker as the single source of truth. The file must exist in the repo root and include LMS_* values plus POSTGRES_* for the database container.

Set LMS_ENV_FILE=/app/.env.docker for api/web containers and mount .env.docker into /app/.env.docker so both services can load the same config.

Docker compose also includes Redis and MinIO. Required env keys (from .env.docker):
- LMS_REDIS_PORT, LMS_REDIS_URL
- LMS_MINIO_PORT, LMS_MINIO_CONSOLE_PORT
- MINIO_ROOT_USER, MINIO_ROOT_PASSWORD
- LMS_MINIO_ENDPOINT, LMS_MINIO_ACCESS_KEY, LMS_MINIO_SECRET_KEY, LMS_MINIO_BUCKET

### Auth mode

- LMS_AUTH_MODE=mock (default): username -> role mapping, password ignored.
- LMS_AUTH_MODE=local: login uses stored users. Use POST /auth/bootstrap (one-time, when no users exist) to create the first SuperAdmin.

### Endpoint parity

The following endpoints must behave the same in local and docker modes:

- GET /health
- GET /version
- POST /auth/login
- POST /auth/bootstrap (local auth only)
- GET /roles
- GET /users
- POST /users
- PATCH /users/:id
- DELETE /users/:id
- GET /courses
- POST /courses
- GET /courses/:id
- PATCH /courses/:id
- DELETE /courses/:id
- GET /content
- GET /exams
- POST /exams
- GET /questions
- POST /questions

### Smoke tests

- Local: scripts/smoke_local.ps1
- Docker: scripts/smoke_docker.ps1
- Questions (local): scripts/smoke_questions.ps1

Both smoke scripts run /health, /version, login, roles, list endpoints, and a minimal create/delete cycle for courses/exams/questions.

### How to verify (local)

1. pnpm env:detect
2. pnpm dev:api
3. pnpm dev:web
4. pnpm smoke:local

Expected output: health status ok, version matches LMS_API_VERSION

### Fast local boot

Use scripts\\launch_local.ps1 to spawn API/Web terminals quickly. Add -WithMobile or -WithOmr for extra services. Add -Seed to wait for API and insert demo data automatically.

### Seed demo data

Run scripts\\seed_demo.ps1 to insert a small demo dataset (courses + questions).
